<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Quizzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
    <h1 id="quizTitle" class="text-3xl font-bold mb-4 text-center">Simple Quizzer</h1>

    <!-- Loading/Setup View - Completely separated from quiz navigation -->
    <div id="setupView" class="mb-6">
      <div id="setupInstructions" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded hidden">
        <h2 class="text-xl font-semibold mb-2">How to Setup a Quiz</h2>
        <p class="text-sm leading-relaxed">
          Provide your quiz in JSON format, either by pasting it into the text area, uploading a <code>.json</code> file, or dragging and dropping files. The format should include an array of question objects, each with:
        </p>
        <pre class="bg-white p-3 mt-2 border rounded text-sm overflow-x-auto"><code>{
  "title": "Optional quiz title string",
  "questions": [
    {
      "question": "What does IAM stand for?",
      "options": [
        "A. Identity and Access Management",
        "B. Internal Application Mechanism",
        "C. Internet Access Mode",
        "D. Infrastructure Assignment Module"
      ],
      "answer": "A. Identity and Access Management",
      "explanation": "IAM stands for Identity and Access Management, a framework for defining and managing access policies."
    }
    // Add more question objects...
  ]
}</code></pre>
        <p class="text-sm mt-2">All fields inside each question are required except for <code>explanation</code>. The <code>title</code> is also optional and will override the quiz title heading.</p>
        
        <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded">
          <h3 class="font-semibold text-green-800 mb-2">üîó URL Parameters for Auto-Loading</h3>
          <p class="text-sm text-green-700 mb-2">You can automatically load quizzes using URL parameters:</p>
          <ul class="text-xs text-green-600 space-y-1">
            <li><strong>Remote URL:</strong> <code>?quiz=https://example.com/quiz.json</code></li>
            <li><strong>Quiz Name:</strong> <code>?mlb_expert</code> (loads ./quizzes/mlb_expert.json)</li>
            <li><strong>Quiz File:</strong> <code>?file=baseball_history</code> (loads ./quizzes/baseball_history.json)</li>
            <li><strong>Base64 Data:</strong> <code>?data=eyJ0aXRsZSI6Ik15IFF1aXoiLCAicXVlc3Rpb25zIjpbXX0=</code></li>
            <li><strong>Hash Fragment:</strong> <code>#{"title":"My Quiz","questions":[...]}</code></li>
          </ul>
        </div>
        
        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
          <h3 class="font-semibold text-yellow-800 mb-2">üé≤ Randomization Features</h3>
          <p class="text-sm text-yellow-700">Questions and answer options are automatically randomized each time you start a quiz to provide a fresh experience!</p>
        </div>
      </div>

      <div id="setupForm" class="mb-6">
        <h3 class="text-xl font-semibold mb-3">Load Quiz Data</h3>
        <div class="mb-3">
          <button class="text-sm text-blue-600 hover:text-blue-800 underline" onclick="toggleInstructions()">Show Setup Instructions</button>
        </div>
        
        <!-- Enhanced File Upload Area with Drag & Drop -->
        <div id="dropZone" class="w-full h-40 p-6 border-2 border-dashed border-gray-300 rounded-lg mb-3 transition-all duration-200 bg-gray-50 hover:bg-gray-100 flex flex-col items-center justify-center text-center cursor-pointer">
          <div id="dropContent">
            <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <p class="text-sm text-gray-600 font-medium">Drag & drop JSON files here</p>
            <p class="text-xs text-gray-500 mt-1">or click to browse files</p>
          </div>
          <input type="file" id="jsonFile" accept="application/json,.json" class="hidden" />
        </div>
        
        <!-- JSON Text Area -->
        <div class="mb-3">
          <label for="jsonSeed" class="block text-sm font-medium text-gray-700 mb-1">Or paste JSON content:</label>
          <textarea id="jsonSeed" class="w-full h-32 p-3 border border-gray-300 rounded-lg font-mono text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Paste your JSON quiz data here..."></textarea>
        </div>
        
        <div class="flex items-center space-x-4">
          <button class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded font-medium transition-colors" onclick="loadFromJson()">Start Quiz</button>
          <button class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded font-medium transition-colors" onclick="clearInputs()">Clear All</button>
        </div>
        
        <div id="loadingError" class="mt-2 text-red-600 text-sm hidden"></div>
        <div id="autoLoadStatus" class="mt-2 text-blue-600 text-sm hidden"></div>
      </div>
    </div>

    <!-- Quiz View - Separated navigation that cannot return to setup -->
    <div id="quizView" class="hidden">
      <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded">
        <p class="text-sm text-green-800">
          <strong>Quiz in Progress:</strong> Navigate between questions using the buttons below. Your answers are automatically saved. Questions and answers have been randomized for this session.
        </p>
      </div>
      
      <div id="quiz" class="mb-6"></div>
      
      <div class="flex justify-between items-center mb-6">
        <button class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-4 py-2 rounded transition-colors" onclick="navigateToQuestion('prev')" id="prevBtn">‚Üê Previous</button>
        
        <div class="flex-1 mx-6">
          <!-- Text Progress Indicator -->
          <div id="progress" class="text-sm text-gray-600 font-medium text-center mb-2"></div>
          <!-- Visual Progress Bar -->
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
          </div>
        </div>
        
        <button class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-4 py-2 rounded transition-colors" onclick="navigateToQuestion('next')" id="nextBtn">Next ‚Üí</button>
      </div>
      
      <div class="border-t pt-4">
        <button class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded text-lg font-medium transition-colors" onclick="showReportView()">Finish Quiz & View Results</button>
      </div>
    </div>

    <!-- Report View -->
    <div id="reportView" class="hidden">
      <div id="report" class="mt-8"></div>
      <div class="mt-6 flex flex-wrap gap-4">
        <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-medium transition-colors" onclick="resetToSetup()">Start New Quiz</button>
        <button class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded font-medium transition-colors" onclick="retakeCurrentQuiz()">Retake This Quiz</button>
        <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-medium transition-colors" onclick="shareQuiz()">Share This Quiz</button>
      </div>
      <div id="shareResults" class="mt-4 p-3 bg-gray-50 border rounded hidden">
        <h4 class="font-semibold mb-2">Shareable Quiz URL:</h4>
        <div class="flex items-center space-x-2">
          <input type="text" id="shareUrl" class="flex-1 p-2 border rounded font-mono text-xs" readonly>
          <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm" onclick="copyShareUrl()">Copy</button>
        </div>
        <p class="text-xs text-gray-600 mt-2">Share this URL to let others take the same quiz!</p>
      </div>
    </div>
  </div>

  <script>
    // Global state management
    let questions = [];
    let originalQuestions = []; // Store original order for sharing
    let currentQuestionIndex = 0;
    let userAnswers = {};
    let quizStartTime = null;

    // Initialize application state
    function initializeApp() {
      try {
        userAnswers = loadUserAnswersFromStorage();
        console.log('Application initialized successfully');
        
        // Setup drag and drop functionality
        setupDragAndDrop();
        
        // Check for auto-load parameters
        checkAutoLoadParameters();
      } catch (error) {
        console.error('Error initializing application:', error);
        userAnswers = {};
      }
    }

    // Setup drag and drop functionality for file uploads
    function setupDragAndDrop() {
      try {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('jsonFile');
        
        // Make drop zone clickable
        dropZone.addEventListener('click', () => {
          fileInput.click();
        });
        
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop zone when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });
        
        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);
        
        // Handle file input change
        fileInput.addEventListener('change', handleFileInputChange, false);
        
        console.log('Drag and drop functionality setup complete');
      } catch (error) {
        console.error('Error setting up drag and drop:', error);
      }
    }

    // Prevent default drag behaviors
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Highlight drop zone
    function highlight(e) {
      const dropZone = document.getElementById('dropZone');
      dropZone.classList.add('border-blue-500', 'bg-blue-50');
      dropZone.classList.remove('border-gray-300', 'bg-gray-50');
    }

    // Remove highlight from drop zone
    function unhighlight(e) {
      const dropZone = document.getElementById('dropZone');
      dropZone.classList.remove('border-blue-500', 'bg-blue-50');
      dropZone.classList.add('border-gray-300', 'bg-gray-50');
    }

    // Handle file drop
    function handleDrop(e) {
      try {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          const file = files[0];
          console.log('File dropped:', file.name);
          processFileUpload(file);
        }
      } catch (error) {
        console.error('Error handling file drop:', error);
        showError('Error processing dropped file: ' + error.message);
      }
    }

    // Handle file input change
    function handleFileInputChange(e) {
      try {
        const files = e.target.files;
        if (files.length > 0) {
          console.log('File selected:', files[0].name);
          processFileUpload(files[0]);
        }
      } catch (error) {
        console.error('Error handling file input change:', error);
        showError('Error processing selected file: ' + error.message);
      }
    }

    // Process uploaded file
    function processFileUpload(file) {
      try {
        // Validate file type
        if (!file.type.includes('json') && !file.name.toLowerCase().endsWith('.json')) {
          throw new Error('Please select a valid JSON file (.json extension required).');
        }
        
        // Update drop zone to show loading state
        const dropContent = document.getElementById('dropContent');
        dropContent.innerHTML = `
          <div class="text-blue-600">
            <svg class="animate-spin mx-auto h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm font-medium">Loading ${file.name}...</p>
          </div>
        `;
        
        const reader = new FileReader();
        reader.onload = function(event) {
          try {
            const parsedData = JSON.parse(event.target.result);
            validateQuizJson(parsedData);
            processValidatedJson(parsedData);
            console.log('File processed successfully:', file.name);
          } catch (error) {
            console.error('Error parsing uploaded file:', error);
            showError('Error loading JSON file: ' + error.message);
            resetDropZone();
          }
        };
        
        reader.onerror = function() {
          showError('Error reading the selected file. Please try again.');
          resetDropZone();
        };
        
        reader.readAsText(file);
      } catch (error) {
        console.error('Error processing file upload:', error);
        showError('Error processing file: ' + error.message);
        resetDropZone();
      }
    }

    // Reset drop zone to original state
    function resetDropZone() {
      const dropContent = document.getElementById('dropContent');
      dropContent.innerHTML = `
        <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        <p class="text-sm text-gray-600 font-medium">Drag & drop JSON files here</p>
        <p class="text-xs text-gray-500 mt-1">or click to browse files</p>
      `;
    }

    // Array shuffling utility (Fisher-Yates algorithm)
    function shuffleArray(array) {
      const shuffled = [...array]; // Create a copy to avoid mutating original
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // Randomize question and answer order
    function randomizeQuizContent(questionsArray) {
      try {
        console.log('Randomizing quiz content...');
        
        // Store original order for sharing purposes
        originalQuestions = [...questionsArray];
        
        // Shuffle questions
        const shuffledQuestions = shuffleArray(questionsArray);
        
        // Shuffle answer options for each question while preserving correctness
        const randomizedQuestions = shuffledQuestions.map((question, index) => {
          const originalOptions = [...question.options];
          const shuffledOptions = shuffleArray(originalOptions);
          
          // Find the new position of the correct answer
          const correctAnswerIndex = shuffledOptions.findIndex(option => option === question.answer);
          
          return {
            ...question,
            id: index + 1, // Reassign sequential IDs after shuffling
            options: shuffledOptions,
            answer: question.answer // Keep the correct answer text unchanged
          };
        });
        
        console.log(`Randomized ${randomizedQuestions.length} questions with shuffled answer options`);
        return randomizedQuestions;
      } catch (error) {
        console.error('Error randomizing quiz content:', error);
        // Return original if randomization fails
        return questionsArray.map((q, index) => ({ ...q, id: index + 1 }));
      }
    }

    // Auto-loading functionality for URL parameters and external sources
    function checkAutoLoadParameters() {
      try {
        showAutoLoadStatus('Checking for auto-load parameters...');
        
        // Check URL query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const quizUrl = urlParams.get('quiz');
        const fileName = urlParams.get('file');
        const base64Data = urlParams.get('data');
        
        // Check for direct quiz name as first query parameter (e.g., ?mlb_expert)
        const directQuizName = extractDirectQuizName();
        
        // Check hash fragment for JSON data
        const hashData = window.location.hash.substring(1);
        
        if (quizUrl) {
          showAutoLoadStatus('Loading quiz from remote URL...');
          loadQuizFromUrl(quizUrl);
        } else if (fileName) {
          showAutoLoadStatus('Loading quiz from local file...');
          loadQuizFromLocalFile(fileName);
        } else if (directQuizName) {
          showAutoLoadStatus('Loading quiz from query name...');
          loadQuizFromLocalFile(directQuizName);
        } else if (base64Data) {
          showAutoLoadStatus('Loading quiz from base64 data...');
          loadQuizFromBase64(base64Data);
        } else if (hashData) {
          showAutoLoadStatus('Loading quiz from hash fragment...');
          loadQuizFromHashFragment(hashData);
        } else {
          hideAutoLoadStatus();
          console.log('No auto-load parameters found');
        }
      } catch (error) {
        console.error('Error checking auto-load parameters:', error);
        showAutoLoadError('Error checking auto-load parameters: ' + error.message);
      }
    }

    // Extract direct quiz name from query string (e.g., ?mlb_expert -> mlb_expert)
    function extractDirectQuizName() {
      try {
        const queryString = window.location.search;
        if (!queryString || queryString.length <= 1) {
          return null;
        }
        
        // Remove the ? and get the first parameter
        const firstParam = queryString.substring(1).split('&')[0];
        
        // Check if it's a key=value pair or just a key
        if (firstParam && !firstParam.includes('=')) {
          // It's just a quiz name without equals sign
          const quizName = decodeURIComponent(firstParam);
          console.log('Extracted direct quiz name:', quizName);
          return quizName;
        }
        
        return null;
      } catch (error) {
        console.error('Error extracting direct quiz name:', error);
        return null;
      }
    }

    // Load quiz from local file in quizzes directory
    async function loadQuizFromLocalFile(fileName) {
      try {
        // Construct path to quizzes subdirectory
        const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
        const quizPath = `${basePath}quizzes/${fileName}.json`;
        const fullUrl = window.location.origin + quizPath;
        
        console.log('Loading quiz from local file:', fullUrl);
        showAutoLoadStatus(`Loading quiz from: ${fileName}.json`);
        
        const response = await fetch(quizPath);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: Could not load ${fileName}.json from quizzes directory. Make sure the file exists at ${quizPath}`);
        }
        
        const jsonData = await response.json();
        showAutoLoadStatus('Quiz data loaded successfully! Starting quiz...');
        
        // Validate and process the JSON
        validateQuizJson(jsonData);
        processValidatedJson(jsonData);
        
        console.log('Quiz loaded successfully from local file');
      } catch (error) {
        console.error('Error loading quiz from local file:', error);
        showAutoLoadError(`Failed to load quiz file "${fileName}.json": ${error.message}`);
      }
    }

    // Load quiz from remote URL
    async function loadQuizFromUrl(url) {
      try {
        console.log('Fetching quiz from URL:', url);
        showAutoLoadStatus('Fetching quiz data from: ' + url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          console.warn('Response may not be JSON, attempting to parse anyway');
        }
        
        const jsonData = await response.json();
        showAutoLoadStatus('Quiz data loaded successfully! Starting quiz...');
        
        // Validate and process the JSON
        validateQuizJson(jsonData);
        processValidatedJson(jsonData);
        
        console.log('Quiz loaded successfully from URL');
      } catch (error) {
        console.error('Error loading quiz from URL:', error);
        showAutoLoadError('Failed to load quiz from URL: ' + error.message);
      }
    }

    // Load quiz from base64 encoded data
    function loadQuizFromBase64(base64Data) {
      try {
        console.log('Decoding base64 quiz data');
        showAutoLoadStatus('Decoding base64 quiz data...');
        
        // Decode base64 string
        const decodedString = atob(base64Data);
        const jsonData = JSON.parse(decodedString);
        
        showAutoLoadStatus('Quiz data decoded successfully! Starting quiz...');
        
        // Validate and process the JSON
        validateQuizJson(jsonData);
        processValidatedJson(jsonData);
        
        console.log('Quiz loaded successfully from base64 data');
      } catch (error) {
        console.error('Error loading quiz from base64:', error);
        showAutoLoadError('Failed to decode base64 quiz data: ' + error.message);
      }
    }

    // Load quiz from hash fragment JSON
    function loadQuizFromHashFragment(hashData) {
      try {
        console.log('Parsing hash fragment quiz data');
        showAutoLoadStatus('Parsing hash fragment quiz data...');
        
        // Try to decode if it looks like base64, otherwise parse directly
        let jsonData;
        try {
          // Check if it might be URL-encoded
          const decodedHash = decodeURIComponent(hashData);
          jsonData = JSON.parse(decodedHash);
        } catch (firstError) {
          // If that fails, try base64 decoding
          try {
            const decodedString = atob(hashData);
            jsonData = JSON.parse(decodedString);
          } catch (secondError) {
            // If that fails too, try direct parsing
            jsonData = JSON.parse(hashData);
          }
        }
        
        showAutoLoadStatus('Quiz data parsed successfully! Starting quiz...');
        
        // Validate and process the JSON
        validateQuizJson(jsonData);
        processValidatedJson(jsonData);
        
        console.log('Quiz loaded successfully from hash fragment');
      } catch (error) {
        console.error('Error loading quiz from hash fragment:', error);
        showAutoLoadError('Failed to parse hash fragment quiz data: ' + error.message);
      }
    }

    // Show auto-load status message
    function showAutoLoadStatus(message) {
      const statusElement = document.getElementById('autoLoadStatus');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.classList.remove('hidden');
        statusElement.classList.add('text-blue-600');
        statusElement.classList.remove('text-red-600');
      }
      console.log('Auto-load status:', message);
    }

    // Show auto-load error message
    function showAutoLoadError(message) {
      const statusElement = document.getElementById('autoLoadStatus');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.classList.remove('hidden');
        statusElement.classList.add('text-red-600');
        statusElement.classList.remove('text-blue-600');
      }
      console.error('Auto-load error:', message);
    }

    // Hide auto-load status
    function hideAutoLoadStatus() {
      const statusElement = document.getElementById('autoLoadStatus');
      if (statusElement) {
        statusElement.classList.add('hidden');
      }
    }

    // Generate shareable URLs for quizzes
    function generateShareableUrl(quizData, method = 'base64') {
      try {
        const baseUrl = window.location.origin + window.location.pathname;
        
        if (method === 'base64') {
          const jsonString = JSON.stringify(quizData);
          const base64Data = btoa(jsonString);
          return `${baseUrl}?data=${encodeURIComponent(base64Data)}`;
        } else if (method === 'hash') {
          const jsonString = JSON.stringify(quizData);
          return `${baseUrl}#${encodeURIComponent(jsonString)}`;
        }
        
        throw new Error('Invalid method specified');
      } catch (error) {
        console.error('Error generating shareable URL:', error);
        return null;
      }
    }

    // Local storage management for persistent state
    function saveUserAnswersToStorage() {
      try {
        const stateData = {
          answers: userAnswers,
          timestamp: new Date().toISOString(),
          currentIndex: currentQuestionIndex
        };
        localStorage.setItem('quizState', JSON.stringify(stateData));
        console.log('User answers saved to storage');
      } catch (error) {
        console.error('Error saving state to storage:', error);
      }
    }

    function loadUserAnswersFromStorage() {
      try {
        const saved = localStorage.getItem('quizState');
        if (saved) {
          const stateData = JSON.parse(saved);
          console.log('User answers loaded from storage');
          return stateData.answers || {};
        }
        return {};
      } catch (error) {
        console.error('Error loading state from storage:', error);
        return {};
      }
    }

    function clearStorageState() {
      try {
        localStorage.removeItem('quizState');
        console.log('Storage state cleared');
      } catch (error) {
        console.error('Error clearing storage state:', error);
      }
    }

    // Clear all input fields
    function clearInputs() {
      try {
        document.getElementById('jsonSeed').value = '';
        document.getElementById('jsonFile').value = '';
        resetDropZone();
        hideError();
        hideAutoLoadStatus();
        console.log('All inputs cleared');
      } catch (error) {
        console.error('Error clearing inputs:', error);
      }
    }

    // Question rendering with proper answer isolation
    function renderCurrentQuestion() {
      try {
        const question = questions[currentQuestionIndex];
        if (!question) {
          throw new Error(`Question at index ${currentQuestionIndex} not found`);
        }

        // Retrieve saved answer for current question only
        const savedAnswer = userAnswers[question.id] || {
          selected: null,
          notes: '',
          comfort: null
        };

        const quizContainer = document.getElementById('quiz');
        
        // Generate HTML for current question with isolated answer options
        quizContainer.innerHTML = `
          <div class="space-y-6">
            <div class="bg-gray-50 p-4 rounded border">
              <h3 class="text-lg font-semibold text-gray-800 mb-2">Question ${question.id}</h3>
              <div class="text-xl font-medium text-gray-900">${escapeHtml(question.question)}</div>
            </div>
            
            <div class="space-y-3">
              <h4 class="font-medium text-gray-700">Select your answer:</h4>
              ${question.options.map((option, optionIndex) => {
                const isSelected = savedAnswer.selected === option;
                const optionId = `option_q${question.id}_${optionIndex}`;
                return `
                  <label class="block cursor-pointer" for="${optionId}">
                    <input 
                      type="radio" 
                      id="${optionId}"
                      name="question_${question.id}_options" 
                      value="${escapeHtml(option)}" 
                      class="sr-only" 
                      ${isSelected ? 'checked' : ''}
                      onchange="handleAnswerSelection(this)"
                    >
                    <span class="inline-block p-3 border rounded w-full transition-all duration-200 ${isSelected ? 'bg-blue-100 border-blue-500 ring-2 ring-blue-200' : 'hover:bg-gray-50 border-gray-300'}">
                      ${escapeHtml(option)}
                    </span>
                  </label>`;
              }).join('')}
            </div>
            
            <div class="space-y-3">
              <label class="block">
                <span class="font-medium text-gray-700">Personal Notes:</span>
                <textarea 
                  id="questionNotes" 
                  class="w-full mt-1 p-3 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                  rows="3"
                  placeholder="Add any notes or thoughts about this question..."
                  oninput="handleNotesInput(this)"
                >${escapeHtml(savedAnswer.notes || '')}</textarea>
              </label>
            </div>
            
            <div class="space-y-3">
              <span class="block font-medium text-gray-700">Comfort Level with this topic:</span>
              <div id="comfortOptions" class="flex justify-between space-x-2">
                ${[1,2,3,4,5].map(comfortValue => {
                  const comfortLabels = ['Very Uncomfortable', 'Uncomfortable', 'Neutral', 'Comfortable', 'Very Comfortable'];
                  const isSelected = savedAnswer.comfort == comfortValue;
                  const comfortId = `comfort_q${question.id}_${comfortValue}`;
                  return `
                    <label class="flex flex-col items-center cursor-pointer flex-1" for="${comfortId}">
                      <input 
                        type="radio" 
                        id="${comfortId}"
                        name="question_${question.id}_comfort" 
                        value="${comfortValue}" 
                        class="mb-2" 
                        ${isSelected ? 'checked' : ''}
                        onchange="handleComfortSelection(this)"
                      >
                      <span class="text-xs text-center px-1">${comfortLabels[comfortValue-1]}</span>
                    </label>`;
                }).join('')}
              </div>
            </div>
          </div>
        `;

        // Update navigation and progress indicators
        updateNavigationState();
        updateProgressIndicator();
        
        console.log(`Rendered question ${question.id} (index ${currentQuestionIndex})`);
      } catch (error) {
        console.error('Error rendering question:', error);
        showError('Failed to render question. Please try refreshing the page.');
      }
    }

    // Handle answer selection with proper question isolation
    function handleAnswerSelection(radioInput) {
      try {
        const currentQuestion = questions[currentQuestionIndex];
        if (!currentQuestion) {
          throw new Error('No current question available');
        }

        // Initialize answer object for current question if it doesn't exist
        if (!userAnswers[currentQuestion.id]) {
          userAnswers[currentQuestion.id] = { selected: null, notes: '', comfort: null };
        }

        // Update selected answer for current question only
        userAnswers[currentQuestion.id].selected = radioInput.value;
        
        // Save state and re-render to update visual feedback
        saveUserAnswersToStorage();
        console.log(`Answer selected for question ${currentQuestion.id}: ${radioInput.value}`);
        
        // Re-render to update styling without losing focus
        setTimeout(() => renderCurrentQuestion(), 100);
      } catch (error) {
        console.error('Error handling answer selection:', error);
      }
    }

    // Handle notes input with question isolation
    function handleNotesInput(textareaElement) {
      try {
        const currentQuestion = questions[currentQuestionIndex];
        if (!currentQuestion) return;

        if (!userAnswers[currentQuestion.id]) {
          userAnswers[currentQuestion.id] = { selected: null, notes: '', comfort: null };
        }

        userAnswers[currentQuestion.id].notes = textareaElement.value;
        saveUserAnswersToStorage();
        console.log(`Notes updated for question ${currentQuestion.id}`);
      } catch (error) {
        console.error('Error handling notes input:', error);
      }
    }

    // Handle comfort level selection with question isolation
    function handleComfortSelection(radioInput) {
      try {
        const currentQuestion = questions[currentQuestionIndex];
        if (!currentQuestion) return;

        if (!userAnswers[currentQuestion.id]) {
          userAnswers[currentQuestion.id] = { selected: null, notes: '', comfort: null };
        }

        userAnswers[currentQuestion.id].comfort = parseInt(radioInput.value);
        saveUserAnswersToStorage();
        console.log(`Comfort level set for question ${currentQuestion.id}: ${radioInput.value}`);
      } catch (error) {
        console.error('Error handling comfort selection:', error);
      }
    }

    // Navigation between questions with proper bounds checking
    function navigateToQuestion(direction) {
      try {
        const previousIndex = currentQuestionIndex;
        
        if (direction === 'prev' && currentQuestionIndex > 0) {
          currentQuestionIndex--;
        } else if (direction === 'next' && currentQuestionIndex < questions.length - 1) {
          currentQuestionIndex++;
        } else {
          console.log(`Navigation blocked: already at ${direction === 'prev' ? 'first' : 'last'} question`);
          return;
        }

        console.log(`Navigated from question ${previousIndex + 1} to question ${currentQuestionIndex + 1}`);
        renderCurrentQuestion();
      } catch (error) {
        console.error('Error navigating between questions:', error);
        // Revert to previous index on error
        currentQuestionIndex = previousIndex;
      }
    }

    // Update navigation button states
    function updateNavigationState() {
      try {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        prevBtn.disabled = currentQuestionIndex === 0;
        nextBtn.disabled = currentQuestionIndex === questions.length - 1;
        
        // Add visual feedback for disabled state
        if (prevBtn.disabled) {
          prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        if (nextBtn.disabled) {
          nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      } catch (error) {
        console.error('Error updating navigation state:', error);
      }
    }

    // Update progress indicator and visual progress bar
    function updateProgressIndicator() {
      try {
        const progressElement = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');
        
        if (progressElement && progressBar) {
          const current = currentQuestionIndex + 1;
          const total = questions.length;
          const percentage = Math.round((current / total) * 100);
          
          // Update text progress
          progressElement.textContent = `Question ${current} of ${total} (${percentage}% complete)`;
          
          // Update visual progress bar
          progressBar.style.width = `${percentage}%`;
          
          // Add color coding based on progress
          if (percentage < 33) {
            progressBar.className = 'bg-red-500 h-2 rounded-full transition-all duration-300 ease-out';
          } else if (percentage < 66) {
            progressBar.className = 'bg-yellow-500 h-2 rounded-full transition-all duration-300 ease-out';
          } else {
            progressBar.className = 'bg-green-500 h-2 rounded-full transition-all duration-300 ease-out';
          }
        }
      } catch (error) {
        console.error('Error updating progress indicator:', error);
      }
    }

    // Show report view with detailed results
    function showReportView() {
      try {
        hideSetupInstructions();
        document.getElementById('quizView').classList.add('hidden');
        document.getElementById('reportView').classList.remove('hidden');
        generateDetailedReport();
        console.log('Report view displayed');
      } catch (error) {
        console.error('Error showing report view:', error);
      }
    }

    // Generate comprehensive quiz report
    function generateDetailedReport() {
      try {
        let correctAnswers = 0;
        const totalQuestions = questions.length;
        let answeredQuestions = 0;

        const questionResults = questions.map(question => {
          const userAnswer = userAnswers[question.id];
          const hasAnswer = userAnswer && userAnswer.selected;
          const isCorrect = hasAnswer && userAnswer.selected === question.answer;
          
          if (hasAnswer) answeredQuestions++;
          if (isCorrect) correctAnswers++;

          const comfortLabels = ['', 'Very Uncomfortable', 'Uncomfortable', 'Neutral', 'Comfortable', 'Very Comfortable'];

          return `
            <li class="mb-4 p-4 border rounded ${isCorrect ? 'bg-green-50 border-green-200' : hasAnswer ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-200'}">
              <div class="font-semibold ${isCorrect ? 'text-green-700' : hasAnswer ? 'text-red-600' : 'text-gray-600'} mb-2">
                Question ${question.id}: ${isCorrect ? '‚úì Correct' : hasAnswer ? '‚úó Incorrect' : '‚ö™ Not Answered'}
              </div>
              <div class="text-sm text-gray-700 mb-2">
                <strong>Question:</strong> ${escapeHtml(question.question)}
              </div>
              <div class="ml-4 text-sm space-y-1">
                <div><strong>Your Answer:</strong> <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${escapeHtml(userAnswer?.selected || 'None')}</span></div>
                <div><strong>Correct Answer:</strong> <span class="text-green-600">${escapeHtml(question.answer)}</span></div>
                <div><strong>Comfort Level:</strong> ${userAnswer?.comfort ? comfortLabels[userAnswer.comfort] : 'Not rated'}</div>
                ${userAnswer?.notes ? `<div><strong>Your Notes:</strong> ${escapeHtml(userAnswer.notes)}</div>` : ''}
                ${question.explanation ? `<div class="mt-2 p-2 bg-blue-50 rounded"><strong>Explanation:</strong> ${escapeHtml(question.explanation)}</div>` : ''}
              </div>
            </li>`;
        }).join('');

        const scorePercentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
        const completionPercentage = totalQuestions > 0 ? Math.round((answeredQuestions / totalQuestions) * 100) : 0;

        document.getElementById('report').innerHTML = `
          <div class="bg-gray-50 p-6 rounded border">
            <h2 class="text-2xl font-bold mb-4 text-center">Quiz Results</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-white p-4 rounded border text-center">
                <div class="text-2xl font-bold text-blue-600">${correctAnswers}/${totalQuestions}</div>
                <div class="text-sm text-gray-600">Correct Answers</div>
              </div>
              <div class="bg-white p-4 rounded border text-center">
                <div class="text-2xl font-bold text-green-600">${scorePercentage}%</div>
                <div class="text-sm text-gray-600">Score</div>
              </div>
              <div class="bg-white p-4 rounded border text-center">
                <div class="text-2xl font-bold text-purple-600">${completionPercentage}%</div>
                <div class="text-sm text-gray-600">Completion</div>
              </div>
            </div>
            
            <h3 class="text-lg font-semibold mb-3">Detailed Results:</h3>
            <ul class="space-y-3">${questionResults}</ul>
          </div>
        `;

        console.log(`Report generated: ${correctAnswers}/${totalQuestions} correct (${scorePercentage}%)`);
      } catch (error) {
        console.error('Error generating report:', error);
        showError('Failed to generate quiz report');
      }
    }

    // Reset application to setup view
    function resetToSetup() {
      try {
        // Clear all state
        questions = [];
        originalQuestions = [];
        currentQuestionIndex = 0;
        userAnswers = {};
        clearStorageState();
        
        // Reset form inputs
        clearInputs();
        
        // Hide share results
        const shareResults = document.getElementById('shareResults');
        if (shareResults) {
          shareResults.classList.add('hidden');
        }
        
        // Show setup view, hide others
        document.getElementById('setupView').classList.remove('hidden');
        document.getElementById('quizView').classList.add('hidden');
        document.getElementById('reportView').classList.add('hidden');
        
        // Ensure setup instructions are hidden by default
        hideSetupInstructions();
        
        // Reset title
        document.getElementById('quizTitle').textContent = 'Simple Quizzer';
        
        console.log('Application reset to setup view');
      } catch (error) {
        console.error('Error resetting to setup:', error);
      }
    }

    // Retake current quiz with cleared answers and new randomization
    function retakeCurrentQuiz() {
      try {
        if (originalQuestions.length === 0) {
          throw new Error('No original quiz data available for retake');
        }
        
        // Clear answers and re-randomize questions
        userAnswers = {};
        currentQuestionIndex = 0;
        clearStorageState();
        
        // Re-randomize the quiz content for a fresh experience
        questions = randomizeQuizContent(originalQuestions);
        
        // Hide instructions and return to quiz view
        hideSetupInstructions();
        document.getElementById('reportView').classList.add('hidden');
        document.getElementById('quizView').classList.remove('hidden');
        
        renderCurrentQuestion();
        console.log('Quiz retake initiated with fresh randomization');
      } catch (error) {
        console.error('Error initiating quiz retake:', error);
        showError('Error starting quiz retake: ' + error.message);
      }
    }

    // JSON validation with comprehensive error checking
    function validateQuizJson(parsedData) {
      try {
        // Handle both array format and object with questions property
        const questionsArray = Array.isArray(parsedData) ? parsedData : parsedData.questions;
        
        if (!Array.isArray(questionsArray)) {
          throw new Error('JSON must contain an array of questions, or an object with a "questions" array property.');
        }
        
        if (questionsArray.length === 0) {
          throw new Error('Questions array cannot be empty.');
        }
        
        // Validate each question thoroughly
        questionsArray.forEach((question, index) => {
          const questionNumber = index + 1;
          
          if (!question || typeof question !== 'object') {
            throw new Error(`Question ${questionNumber} must be an object.`);
          }
          
          if (!question.question || typeof question.question !== 'string' || question.question.trim() === '') {
            throw new Error(`Question ${questionNumber} must have a non-empty "question" string property.`);
          }
          
          if (!Array.isArray(question.options)) {
            throw new Error(`Question ${questionNumber} must have an "options" array property.`);
          }
          
          if (question.options.length < 2) {
            throw new Error(`Question ${questionNumber} must have at least 2 answer options.`);
          }
          
          // Validate each option
          question.options.forEach((option, optionIndex) => {
            if (!option || typeof option !== 'string' || option.trim() === '') {
              throw new Error(`Question ${questionNumber}, option ${optionIndex + 1} must be a non-empty string.`);
            }
          });
          
          if (!question.answer || typeof question.answer !== 'string' || question.answer.trim() === '') {
            throw new Error(`Question ${questionNumber} must have a non-empty "answer" string property.`);
          }
          
          // Verify answer exists in options
          if (!question.options.includes(question.answer)) {
            throw new Error(`Question ${questionNumber}: the "answer" value "${question.answer}" must match exactly one of the provided options.`);
          }
          
          // Validate explanation if present
          if (question.explanation !== undefined && (typeof question.explanation !== 'string')) {
            throw new Error(`Question ${questionNumber}: "explanation" must be a string if provided.`);
          }
        });
        
        console.log(`JSON validation successful: ${questionsArray.length} questions validated`);
        return true;
      } catch (error) {
        console.error('JSON validation failed:', error);
        throw error;
      }
    }

    // Load quiz from JSON input with comprehensive error handling
    function loadFromJson() {
      try {
        hideError();
        
        const seedText = document.getElementById('jsonSeed').value.trim();
        const fileInput = document.getElementById('jsonFile');
        
        // Check if file input has a file
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          processFileUpload(file);
        } else if (seedText) {
          // Process text area input
          const parsedData = JSON.parse(seedText);
          validateQuizJson(parsedData);
          processValidatedJson(parsedData);
        } else {
          throw new Error('Please provide JSON data either by pasting it in the text area, uploading a file, or using drag and drop.');
        }
      } catch (error) {
        console.error('Error loading JSON:', error);
        showError('Error parsing JSON: ' + error.message);
      }
    }

    // Process validated JSON and initialize quiz
    function processValidatedJson(parsedData) {
      try {
        // Extract questions array and optional title
        const questionsArray = Array.isArray(parsedData) ? parsedData : parsedData.questions;
        const quizTitle = parsedData.title;
        
        // Update title if provided
        if (quizTitle && typeof quizTitle === 'string' && quizTitle.trim()) {
          document.getElementById('quizTitle').textContent = quizTitle.trim();
        }
        
        // Process and randomize questions
        const processedQuestions = questionsArray.map((question, index) => ({
          question: question.question.trim(),
          options: question.options.map(opt => opt.trim()),
          answer: question.answer.trim(),
          explanation: question.explanation ? question.explanation.trim() : null
        }));
        
        // Randomize questions and answers
        questions = randomizeQuizContent(processedQuestions);
        
        // Initialize quiz state
        currentQuestionIndex = 0;
        userAnswers = {};
        clearStorageState();
        quizStartTime = new Date();
        
        // Reset drop zone
        resetDropZone();
        
        // Hide setup instructions and switch to quiz view
        hideSetupInstructions();
        hideAutoLoadStatus();
        document.getElementById('setupView').classList.add('hidden');
        document.getElementById('quizView').classList.remove('hidden');
        
        // Render first question
        renderCurrentQuestion();
        
        console.log(`Quiz initialized successfully with ${questions.length} randomized questions`);
      } catch (error) {
        console.error('Error processing validated JSON:', error);
        showError('Error initializing quiz: ' + error.message);
      }
    }

    // Toggle setup instructions visibility
    function toggleInstructions() {
      try {
        const instructionsElement = document.getElementById('setupInstructions');
        const isHidden = instructionsElement.classList.contains('hidden');
        
        if (isHidden) {
          instructionsElement.classList.remove('hidden');
          // Update button text
          event.target.textContent = 'Hide Setup Instructions';
        } else {
          instructionsElement.classList.add('hidden');
          // Update button text
          event.target.textContent = 'Show Setup Instructions';
        }
        
        console.log(`Setup instructions ${isHidden ? 'shown' : 'hidden'}`);
      } catch (error) {
        console.error('Error toggling instructions:', error);
      }
    }

    // Hide setup instructions on any view change
    function hideSetupInstructions() {
      try {
        const instructionsElement = document.getElementById('setupInstructions');
        const toggleButton = document.querySelector('button[onclick="toggleInstructions()"]');
        
        if (instructionsElement) {
          instructionsElement.classList.add('hidden');
        }
        
        if (toggleButton) {
          toggleButton.textContent = 'Show Setup Instructions';
        }
        
        console.log('Setup instructions hidden');
      } catch (error) {
        console.error('Error hiding setup instructions:', error);
      }
    }

    // Error display utilities
    function showError(message) {
      const errorElement = document.getElementById('loadingError');
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.remove('hidden');
      }
      console.error('Error displayed to user:', message);
    }

    function hideError() {
      const errorElement = document.getElementById('loadingError');
      if (errorElement) {
        errorElement.classList.add('hidden');
      }
    }

    // Share quiz functionality
    function shareQuiz() {
      try {
        if (originalQuestions.length === 0) {
          showError('No original quiz data available to share');
          return;
        }

        // Reconstruct the original quiz JSON format using original questions
        const quizData = {
          title: document.getElementById('quizTitle').textContent,
          questions: originalQuestions.map(q => ({
            question: q.question,
            options: q.options,
            answer: q.answer,
            explanation: q.explanation
          }))
        };

        // Generate shareable URL using base64 method
        const shareableUrl = generateShareableUrl(quizData, 'base64');
        
        if (shareableUrl) {
          const shareUrlInput = document.getElementById('shareUrl');
          const shareResults = document.getElementById('shareResults');
          
          shareUrlInput.value = shareableUrl;
          shareResults.classList.remove('hidden');
          
          console.log('Shareable URL generated:', shareableUrl);
        } else {
          showError('Failed to generate shareable URL');
        }
      } catch (error) {
        console.error('Error sharing quiz:', error);
        showError('Error generating shareable URL: ' + error.message);
      }
    }

    // Copy share URL to clipboard
    async function copyShareUrl() {
      try {
        const shareUrlInput = document.getElementById('shareUrl');
        const url = shareUrlInput.value;
        
        if (!url) {
          showError('No URL to copy');
          return;
        }

        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(url);
          showTemporaryMessage('URL copied to clipboard!');
        } else {
          // Fallback for older browsers
          shareUrlInput.select();
          shareUrlInput.setSelectionRange(0, 99999); // For mobile devices
          document.execCommand('copy');
          showTemporaryMessage('URL copied to clipboard!');
        }
        
        console.log('Share URL copied to clipboard');
      } catch (error) {
        console.error('Error copying URL:', error);
        showError('Failed to copy URL to clipboard');
      }
    }

    // Show temporary success message
    function showTemporaryMessage(message) {
      const shareResults = document.getElementById('shareResults');
      const originalContent = shareResults.innerHTML;
      
      shareResults.innerHTML = `
        <div class="text-green-600 font-semibold text-center py-2">
          ‚úì ${message}
        </div>
      `;
      
      setTimeout(() => {
        shareResults.innerHTML = originalContent;
      }, 2000);
    }

    // HTML escaping utility for security
    function escapeHtml(text) {
      if (typeof text !== 'string') return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize application when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      console.log('Enhanced quiz application loaded successfully');
    });
  </script>
</body>
</html>